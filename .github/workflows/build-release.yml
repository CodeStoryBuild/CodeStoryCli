name: Build and Release

on:
  push:
    branches:
      - '*release*'
    tags:
      - 'v*'

jobs:
  build_and_package:
    name: Build & Package ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            platform: windows
            exe_name: dslate.exe
          - os: ubuntu-latest
            platform: linux
            exe_name: dslate
          - os: macos-latest
            platform: macos
            exe_name: dslate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # We install build and pyoxidizer here so the script finds them immediately
          pip install pyoxidizer build pytest
          pip install -e .

      # --- BUILD STEP (Single Source of Truth) ---
      
      - name: Build Executable (PyOxidizer)
        run: python build_exe_opt.py

      # --- TEST STEPS ---

      - name: Create Integration Test Config
        shell: bash
        run: echo "model = 'no-model'"> dslateconfig.toml

      - name: Test Built Executable
        shell: bash
        run: |
          echo ">>> Testing Single File Build"
          if [ "${{ matrix.platform }}" == "windows" ]; then
            EXE_PATH="dist/file/${{ matrix.exe_name }}"
          else
            EXE_PATH="dist/file/${{ matrix.exe_name }}"
          fi
          
          echo "Target Exe: $EXE_PATH"
          # Set the env var for tests to use this specific binary
          export CLI_ARTIFACT_PATH="$EXE_PATH"
          pytest -vv dslate/tests/integration

      # --- PACKAGING STEPS (Installers use the Single File build) ---

      # 1. WINDOWS: Inno Setup
      - name: Install Inno Setup
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install innosetup --no-progress
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create & Compile Windows Installer
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Source points to the single exe file; DestDir puts it directly in {app}
          $issContent = @"
          [Setup]
          AppName=dslate
          AppVersion=1.0
          DefaultDirName={autopf}\dslate
          DefaultGroupName=dslate
          OutputBaseFilename=dslate-windows-installer
          OutputDir=dist\installers
          Compression=lzma
          SolidCompression=yes
          ChangesEnvironment=yes
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          Source: "dist\file\dslate.exe"; DestDir: "{app}"; Flags: ignoreversion

          [Registry]
          Root: HKLM; Subkey: "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"; \
            ValueType: expandsz; ValueName: "Path"; ValueData: "{olddata};{app}"; \
            Check: NeedsAddPath('{app}')

          [Code]
          function NeedsAddPath(Param: string): boolean;
          var
            OrigPath: string;
          begin
            if not RegQueryStringValue(HKEY_LOCAL_MACHINE,
              'SYSTEM\CurrentControlSet\Control\Session Manager\Environment',
              'Path', OrigPath)
            then begin
              Result := True;
              exit;
            end;
            Result := Pos(';' + Param + ';', ';' + OrigPath + ';') = 0;
          end;
          "@

          $issContent | Out-File -FilePath "setup.iss" -Encoding ASCII
          New-Item -ItemType Directory -Force -Path "dist\installers"
          ISCC.exe setup.iss
          
      # 2. LINUX: Build .deb
      - name: Create Linux Installer (.deb)
        if: matrix.os == 'ubuntu-latest'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=$(echo "$VERSION" | sed -E 's/^(v|release[-/]?)//')
          if [[ -z "$VERSION" || ! "$VERSION" =~ ^[0-9] ]]; then VERSION="0.0.1"; fi
          
          mkdir -p dist/package/usr/bin
          mkdir -p dist/installers
          
          # Copy binary directly to /usr/bin
          cp dist/file/dslate dist/package/usr/bin/dslate
          chmod +x dist/package/usr/bin/dslate
          
          mkdir -p dist/package/DEBIAN
          cat > dist/package/DEBIAN/control <<EOF
          Package: dslate
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Your Name <your@email.com>
          Description: dslate CLI tool
          EOF
          
          dpkg-deb --build dist/package dist/installers/dslate-linux-installer.deb

      # 3. MACOS: Build .pkg
      - name: Create macOS Installer (.pkg)
        if: matrix.os == 'macos-latest'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=$(echo "$VERSION" | sed -E 's/^(v|release[-/]?)//')
          if [[ -z "$VERSION" || ! "$VERSION" =~ ^[0-9] ]]; then VERSION="1.0"; fi
          
          mkdir -p dist/installers
          
          # Prepare a root folder for pkgbuild
          mkdir -p dist/pkg_root/usr/local/bin
          cp dist/file/dslate dist/pkg_root/usr/local/bin/
          
          # Generate PKG from the root folder
          pkgbuild --root dist/pkg_root \
                   --identifier com.dslate.cli \
                   --version "$VERSION" \
                   --install-location / \
                   dist/installers/dslate-macos-installer.pkg

      # --- PREPARE ARTIFACTS ---

      - name: Prepare Standalone & Installers
        shell: bash
        run: |
          mkdir -p dist/ready_for_upload
          
          # Copy the standalone executable with a clear name
          if [ "${{ matrix.platform }}" == "windows" ]; then
            cp dist/file/dslate.exe dist/ready_for_upload/dslate-${{ matrix.platform }}-standalone.exe
          else
            cp dist/file/dslate dist/ready_for_upload/dslate-${{ matrix.platform }}-standalone
          fi
          
          # Copy installers
          cp dist/installers/* dist/ready_for_upload/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.platform }}
          path: dist/ready_for_upload/*

  release:
    permissions:
        contents: write
    name: Create Release
    needs: [build_and_package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts/

      - name: Extract version
        id: get_version
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          files: |
            artifacts/release-assets-windows/*
            artifacts/release-assets-linux/*
            artifacts/release-assets-macos/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}