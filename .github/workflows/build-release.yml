name: Build and Release

on:
  push:
    branches:
      - '*release*'
    tags:
      - 'v*'

jobs:
  build_and_package:
    name: Build & Package ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            platform: windows
            exe_name: dslate.exe
            installer_ext: .exe
          - os: ubuntu-latest
            platform: linux
            exe_name: dslate
            installer_ext: .deb
          - os: macos-latest
            platform: macos
            exe_name: dslate
            installer_ext: .pkg

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pytest
          pip install -e .

      # --- BUILD STEP ---
      - name: Build Binary (Folder Mode)
        run: python build_exe.py

      # --- TEST STEP (Run immediately to save time) ---
      - name: Run Integration Tests
        shell: bash
        run: |
          # Locate the binary
          if [ "${{ matrix.platform }}" == "windows" ]; then
            EXE_PATH="dist/dslate/${{ matrix.exe_name }}"
          else
            EXE_PATH="dist/dslate/${{ matrix.exe_name }}"
            chmod +x "$EXE_PATH"
          fi
          
          echo "Testing binary at: $EXE_PATH"
          
          # Run pytest using the built binary
          export CLI_ARTIFACT_PATH="$EXE_PATH"
          pytest -vv dslate/dslate/tests/integration

      # --- PACKAGING STEPS ---

      # 1. WINDOWS: Inno Setup
      - name: Install Inno Setup
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install innosetup --no-progress
          # Add Inno Setup to the PATH so we can use ISCC.exe in the next step
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create & Compile Windows Installer
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # 1. Define the Inno Setup Script (setup.iss) dynamically
          $issContent = @"
          [Setup]
          AppName=dslate
          AppVersion=1.0
          DefaultDirName={autopf}\dslate
          DefaultGroupName=dslate
          OutputBaseFilename=dslate-windows-installer
          OutputDir=dist\installers
          Compression=lzma
          SolidCompression=yes
          ChangesEnvironment=yes
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          ; Ensure we grab the entire folder created by PyInstaller (onedir mode)
          Source: "dist\dslate\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Registry]
          ; Add to PATH variable so users can type 'dslate' in terminal
          Root: HKLM; Subkey: "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"; \
            ValueType: expandsz; ValueName: "Path"; ValueData: "{olddata};{app}"; \
            Check: NeedsAddPath('{app}')

          [Code]
          function NeedsAddPath(Param: string): boolean;
          var
            OrigPath: string;
          begin
            if not RegQueryStringValue(HKEY_LOCAL_MACHINE,
              'SYSTEM\CurrentControlSet\Control\Session Manager\Environment',
              'Path', OrigPath)
            then begin
              Result := True;
              exit;
            end;
            Result := Pos(';' + Param + ';', ';' + OrigPath + ';') = 0;
          end;
          "@

          # 2. Write the script to a file
          $issContent | Out-File -FilePath "setup.iss" -Encoding ASCII

          # 3. Create output directory
          New-Item -ItemType Directory -Force -Path "dist\installers"

          # 4. Run the Inno Setup Compiler (ISCC)
          ISCC.exe setup.iss
          
      # 2. LINUX: Build .deb
      - name: Create Linux Installer (.deb)
        if: matrix.os == 'ubuntu-latest'
        run: |
          VERSION="${{ github.ref_name }}"
          # Clean version string (remove 'v' or 'release')
          VERSION=$(echo "$VERSION" | sed -E 's/^(v|release[-/]?)//')
          # Fallback if not a version tag
          if [[ -z "$VERSION" || ! "$VERSION" =~ ^[0-9] ]]; then VERSION="0.0.1"; fi
          
          mkdir -p dist/package/usr/lib/dslate
          mkdir -p dist/package/usr/bin
          mkdir -p dist/installers
          
          # Copy files to /usr/lib/dslate
          cp -r dist/dslate/* dist/package/usr/lib/dslate/
          
          # Create symlink in /usr/bin
          ln -s /usr/lib/dslate/dslate dist/package/usr/bin/dslate
          
          # Create DEBIAN control file
          mkdir -p dist/package/DEBIAN
          cat > dist/package/DEBIAN/control <<EOF
          Package: dslate
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Your Name <your@email.com>
          Description: dslate CLI tool
          EOF
          
          # Build .deb
          dpkg-deb --build dist/package dist/installers/dslate-installer-linux.deb

      # 3. MACOS: Build .pkg
      - name: Create macOS Installer (.pkg)
        if: matrix.os == 'macos-latest'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=$(echo "$VERSION" | sed -E 's/^(v|release[-/]?)//')
          if [[ -z "$VERSION" || ! "$VERSION" =~ ^[0-9] ]]; then VERSION="1.0"; fi
          
          mkdir -p dist/installers
          
          # pkgbuild builds a component package
          # We install to /usr/local/dslate and rely on user adding path, 
          # OR strictly install to /usr/local/bin (Apple prefers /usr/local for 3rd party)
          
          # Simple approach: Payload-free package that moves the files
          # Or Standard approach:
          
          pkgbuild --root dist/dslate \
                   --identifier com.dslate.cli \
                   --version "$VERSION" \
                   --install-location /usr/local/bin \
                   dist/installers/dslate-installer-macos.pkg

      - name: Upload Installer Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.platform }}
          path: dist/installers/*

  release:
    permissions:
        contents: write
    name: Create Release
    needs: [build_and_package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts/

      - name: Extract version
        id: get_version
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          files: |
            artifacts/installers-windows/*.exe
            artifacts/installers-linux/*.deb
            artifacts/installers-macos/*.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}