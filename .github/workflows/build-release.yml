name: Build and Release

on:
  push:
    branches:
      - '*release*'
    tags:
      - 'v*'

jobs:
  build_and_package:
    name: Build & Package ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            platform: windows
            exe_name: dslate.exe
          - os: ubuntu-latest
            platform: linux
            exe_name: dslate
          - os: macos-latest
            platform: macos
            exe_name: dslate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pytest
          pip install -e .

      # --- BUILD STEPS ---
      
      - name: Build Folder Mode (For Installer)
        run: python build_exe.py --mode folder

      - name: Build OneFile Mode (For Standalone)
        run: python build_exe.py --mode file

      # --- TEST STEPS ---

      - name: Create Integration Test Config
        shell: bash
        run: echo "model = "no-model" > dslateconfig.toml

      - name: Test Folder Build
        shell: bash
        run: |
          echo ">>> Testing Folder Build"
          if [ "${{ matrix.platform }}" == "windows" ]; then
            EXE_PATH="dist/folder/dslate/${{ matrix.exe_name }}"
          else
            EXE_PATH="dist/folder/dslate/${{ matrix.exe_name }}"
            chmod +x "$EXE_PATH"
          fi
          
          export CLI_ARTIFACT_PATH="$EXE_PATH"
          pytest -vv dslate/tests/integration

      - name: Test OneFile Build
        shell: bash
        run: |
          echo ">>> Testing OneFile Build"
          if [ "${{ matrix.platform }}" == "windows" ]; then
            EXE_PATH="dist/file/${{ matrix.exe_name }}"
          else
            EXE_PATH="dist/file/${{ matrix.exe_name }}"
            chmod +x "$EXE_PATH"
          fi
          
          export CLI_ARTIFACT_PATH="$EXE_PATH"
          pytest -vv dslate/tests/integration

      # --- PACKAGING STEPS (Installers use Folder build) ---

      # 1. WINDOWS: Inno Setup
      - name: Install Inno Setup
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install innosetup --no-progress
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create & Compile Windows Installer
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $issContent = @"
          [Setup]
          AppName=dslate
          AppVersion=1.0
          DefaultDirName={autopf}\dslate
          DefaultGroupName=dslate
          OutputBaseFilename=dslate-windows-installer
          OutputDir=dist\installers
          Compression=lzma
          SolidCompression=yes
          ChangesEnvironment=yes
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          ; Note: Using dist\folder path here
          Source: "dist\folder\dslate\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Registry]
          Root: HKLM; Subkey: "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"; \
            ValueType: expandsz; ValueName: "Path"; ValueData: "{olddata};{app}"; \
            Check: NeedsAddPath('{app}')

          [Code]
          function NeedsAddPath(Param: string): boolean;
          var
            OrigPath: string;
          begin
            if not RegQueryStringValue(HKEY_LOCAL_MACHINE,
              'SYSTEM\CurrentControlSet\Control\Session Manager\Environment',
              'Path', OrigPath)
            then begin
              Result := True;
              exit;
            end;
            Result := Pos(';' + Param + ';', ';' + OrigPath + ';') = 0;
          end;
          "@

          $issContent | Out-File -FilePath "setup.iss" -Encoding ASCII
          New-Item -ItemType Directory -Force -Path "dist\installers"
          ISCC.exe setup.iss
          
      # 2. LINUX: Build .deb
      - name: Create Linux Installer (.deb)
        if: matrix.os == 'ubuntu-latest'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=$(echo "$VERSION" | sed -E 's/^(v|release[-/]?)//')
          if [[ -z "$VERSION" || ! "$VERSION" =~ ^[0-9] ]]; then VERSION="0.0.1"; fi
          
          mkdir -p dist/package/usr/lib/dslate
          mkdir -p dist/package/usr/bin
          mkdir -p dist/installers
          
          # Note: Using dist/folder path here
          cp -r dist/folder/dslate/* dist/package/usr/lib/dslate/
          ln -s /usr/lib/dslate/dslate dist/package/usr/bin/dslate
          
          mkdir -p dist/package/DEBIAN
          cat > dist/package/DEBIAN/control <<EOF
          Package: dslate
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Your Name <your@email.com>
          Description: dslate CLI tool
          EOF
          
          dpkg-deb --build dist/package dist/installers/dslate-linux-installer.deb

      # 3. MACOS: Build .pkg
      - name: Create macOS Installer (.pkg)
        if: matrix.os == 'macos-latest'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=$(echo "$VERSION" | sed -E 's/^(v|release[-/]?)//')
          if [[ -z "$VERSION" || ! "$VERSION" =~ ^[0-9] ]]; then VERSION="1.0"; fi
          
          mkdir -p dist/installers
          
          # Note: Using dist/folder path here
          pkgbuild --root dist/folder/dslate \
                   --identifier com.dslate.cli \
                   --version "$VERSION" \
                   --install-location /usr/local/bin \
                   dist/installers/dslate-macos-installer.pkg

      # --- PREPARE ARTIFACTS ---

      - name: Rename Standalone Executable
        shell: bash
        run: |
          # Rename the onefile exe to be descriptive (e.g., dslate-windows-standalone.exe)
          mkdir -p dist/ready_for_upload
          
          if [ "${{ matrix.platform }}" == "windows" ]; then
            cp dist/file/dslate.exe dist/ready_for_upload/dslate-${{ matrix.platform }}-standalone.exe
          else
            cp dist/file/dslate dist/ready_for_upload/dslate-${{ matrix.platform }}-standalone
          fi
          
          # Copy installers to same upload folder
          cp dist/installers/* dist/ready_for_upload/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.platform }}
          path: dist/ready_for_upload/*

  release:
    permissions:
        contents: write
    name: Create Release
    needs: [build_and_package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts/

      - name: Extract version
        id: get_version
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          files: |
            artifacts/release-assets-windows/*
            artifacts/release-assets-linux/*
            artifacts/release-assets-macos/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}