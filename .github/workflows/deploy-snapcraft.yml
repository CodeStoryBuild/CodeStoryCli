name: Deploy to Snap Store

on:
  workflow_run:
    workflows: ["Build and Release"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  deploy_snap:
    name: Deploy to Snap Store
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux Artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-release.yml
          name: release-assets-linux
          path: artifacts/
          workflow_conclusion: success

      - name: Extract version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(git describe --tags --abbrev=0)
          fi
          VERSION=$(echo "$VERSION" | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Extract standalone binary
        run: |
          # Extract from tarball
          TARBALL=$(find artifacts -name "*-standalone.tar.gz" -type f | head -n 1)
          if [ ! -z "$TARBALL" ]; then
            mkdir -p snap-build
            tar -xzf "$TARBALL" -C snap-build
          fi

      - name: Create Snapcraft YAML
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          
          cat > snapcraft.yaml <<EOF
          name: codestory
          version: '$VERSION'
          summary: AI-powered abstraction layer above Git
          description: |
            CodeStory is an AI-powered abstraction layer above Git that helps developers 
            focus on coding while automatically handling Git operations. It simplifies 
            version control with intelligent commit messages, branch management, and more.

          base: core22
          confinement: strict
          grade: stable

          apps:
            cst:
              command: cli.dist/cst
              plugs:
                - home
                - network
                - ssh-keys

          parts:
            codestory:
              plugin: dump
              source: snap-build/
              organize:
                'cli.dist/*': cli.dist/
          EOF

      - name: Build Snap
        uses: snapcore/action-build@v1
        id: build

      - name: Publish to Snap Store
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        with:
          snap: ${{ steps.build.outputs.snap }}
          release: stable
